<?php

require(drupal_get_path('module', 'weglot') . '/vendor/autoload.php');

use Weglot\Client\Factory\Languages;
use Weglot\Client\Api\TranslateEntry;
use Weglot\Client\Api\WordEntry;
use Weglot\Client\Client;
use Weglot\Client\Endpoint\Translate;
use Weglot\Client\Api\Enum\BotType;
use Weglot\Client\Api\Enum\WordType;
use Weglot\Parser\Parser;
use Weglot\Parser\ConfigProvider\ManualConfigProvider;
use Weglot\Parser\ConfigProvider\ServerConfigProvider;

define('WEGLOT_VERSION', '1.0');

/**
 * Helper function
 *
 * @return array
 */
function get_code_original_destination_language(){

	global $language;
	$originalLanguage = language_default();

	$codeOriginalLanguage    = $originalLanguage->language;
    $codeDestinationLanguage = $language->language;

    return array(
        'original' => $codeOriginalLanguage,
        'destination' => $codeDestinationLanguage
    );
}

function weglot_is_eligible_url($url){
    $url = urldecode(weglot_url_to_relative($url));

    //Format exclude URL
    $excludeURL = variable_get("weglot_exclude_url", '');

    if (!empty($excludeURL)) {
        $excludeURL    = preg_replace('#\s+#', ',', trim($excludeURL));

        $excludedUrls  = explode(',', $excludeURL);
        foreach ($excludedUrls as &$ex_url) {
            $ex_url = weglot_url_to_relative($ex_url);
        }
        $excludeURL = implode(',', $excludedUrls);
    }


    $exclusions = preg_replace('#\s+#', ',', $excludeURL);

    $listRegex = [];
    if (!empty($exclusions)) {
        $listRegex  = explode(',', $exclusions);
    }

    foreach ($listRegex as $regex) {
        $str          = weglot_escape_slash($regex);
        $prepareRegex = sprintf('/%s/', $str);
        if (preg_match($prepareRegex, $url) === 1) {
            return false;
        }
    }

    return true;
}

function weglot_escape_slash($str) {
    return str_replace('/', '\/', $str);
}

function weglot_url_to_relative($url){
    if ((substr($url, 0, 7) == 'http://') || (substr($url, 0, 8) == 'https://')) {
        // the current link is an "absolute" URL - parse it to get just the path
        $parsed   = parse_url($url);
        $path     = isset($parsed['path']) ? $parsed['path'] : '';
        $query    = isset($parsed['query']) ? '?' . $parsed['query'] : '';
        $fragment = isset($parsed['fragment']) ? '#' . $parsed['fragment'] : '';

        return $path . $query . $fragment;
    }
    return $url;
}




ob_start('treatPage');

function treatPage($dom)
{
    if (empty($dom) || arg(0) === "admin") { // Empty or only front
        return prepare_render_treat_page($dom);
    }


    $apiKey = variable_get("weglot_api_key", 3);

    if(!$apiKey){
        return prepare_render_treat_page($dom);
    }

    $codeLanguages = get_code_original_destination_language();

    global $base_url;
    $current_path = current_path();
    $current_url_no_language  = sprintf("%s/%s", $base_url, $current_path);
    $current_url  = sprintf("%s/%s/%s", $base_url, $codeLanguages['destination'], $current_path);

    $paramsTreatPage = array();

    if(weglot_is_eligible_url($current_url_no_language)){
        $paramsTreatPage["widget"] =  widget_html();
    }

    if($codeLanguages["destination"] === $codeLanguages["original"]){
        return prepare_render_treat_page($dom, $paramsTreatPage);
    }


    if (!weglot_is_eligible_url($current_url_no_language)) {
        drupal_goto($current_url_no_language);
        return;
    }

    $client = new Client($apiKey);

    $config = new ServerConfigProvider();

    $excludeBlocks  = array("#toolbar","#overlay", ".page-admin", "#comment-body-add-more-wrapper");

    $optionsExcludeBlocks = variable_get("weglot_exclude_blocks", '');
    $optionsExcludeBlocks = explode(",", $optionsExcludeBlocks);
    $excludeBlocks = array_merge($excludeBlocks, $optionsExcludeBlocks);

    $parser = new Parser($client, $config, $excludeBlocks);

    $content =  $parser->translate($dom, $codeLanguages["original"], $codeLanguages["destination"]);

    return prepare_render_treat_page($content, $paramsTreatPage);
}

/**
 * Render treat page
 *
 * @param string $dom
 * @param array $params
 * @return string
 */
function prepare_render_treat_page($dom, $params = array()){
    if(isset($params["widget"])){
        return str_replace('</body>', $params["widget"] . '</body>', $dom);
    }

    return $dom;
}

/**
 * Impletation of hook_preprocess_page
 *
 * @return void
 */
function weglot_preprocess_page(&$vars, $hook) {

    if (arg(0) !== "admin") { // Only front
        drupal_add_js(drupal_get_path('module', 'weglot') . '/weglot-front.js');
        drupal_add_css(drupal_get_path('module', 'weglot') . '/weglot-front.css');
    }
}


/**
 * Implementation of hook_permission().
 */
function weglot_permission()
{
    return array(
        'access weglot' => array('title' => t('Access weglot'))
    );
}

/**
 * Implementation of hook_block_info()
 */
function weglot_block_info()
{
    $block['weglot'] = array(
        'info' => t('Block info de weglot')
    );

    return $block;

}

/**
 * Implementation of hook_menu().
 */
function weglot_menu()
{
    $items = array();

    $items['admin/settings/weglot'] = array(
        'title' => 'Weglot',
        'description' => 'Weglot module settings control',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('admin_weglot'),
        'access arguments' => array('Modify Weglot settings'),
        'type' => MENU_NORMAL_ITEM,
    );

    return $items;
}

/**
 * Implementation of hook_preprocess_html
 */
function weglot_preprocess_html(&$variables) {
    // Add conditional stylesheets for admin pages on admin theme.
    if (arg(0)=="admin") {
        // reference your own stylesheet
        drupal_add_css(drupal_get_path('module', 'weglot') . '/weglot.css');
        drupal_add_js(drupal_get_path('module', 'weglot') . '/weglot.js');
    }
}


/**
 * Callback from weglot_menu
 */
function admin_weglot()
{

    $form['general'] = array(
        '#type' => 'fieldset',
        '#title' => t('General Configuration'),
        '#collapsible' => false,
        '#collapsed' => false,
    );

    $form['general']['weglot_api_key'] = array(
        '#type' => 'textfield',
        '#title' => t('Api Key'),
        '#default_value' => variable_get('weglot_api_key', ''),
        '#description' => t("Log in to <a target='_blank' href='https://weglot.com/register-wordpress
'>Weglot</a> to get your API key."),
        '#required' => true
    );

    $form['exclusion'] = array(
        '#type' => 'fieldset',
        '#title' => t('Translation exclusion (optional)'),
        '#description' => t('By default, every page is translated. You can exclude parts of a page or a full page here.'),
        '#collapsible' => true,
        '#collapsed' => false,
    );

    $form['exclusion']['weglot_exclude_url'] = array(
        '#type' => 'textarea',
        '#title' => 'Exclude URL here',
        '#description' => t('You can write regex.'),
        '#default_value' => variable_get('weglot_exclude_url', '')
    );

    $form['exclusion']['weglot_exclude_blocks'] = array(
        '#type' => 'textarea',
        '#title' => 'Exclude blocks',
        '#description' => t('Enter CSS selectors, separated by commas.'),
        '#default_value' => variable_get('weglot_exclude_blocks', '')
    );


    return system_settings_form($form);

}

function widget_html(){

    $codeLanguages = get_code_original_destination_language();
    $is_dropdown = true;
    $withname    = true;
    $flag_class  = 'wg-flags ';
    $tag         = $is_dropdown ? 'div' : 'li';
    $listTag     = $is_dropdown ? '<ul>' : '';

    $widget = sprintf('<!--Weglot %s-->', WEGLOT_VERSION);
    $widget .= "<aside data-wg-notranslate='' id='weglot-selector' class='wg-default wg-drop country-selector closed'>";

    global $base_url;
    $current_path = current_path();
    $listLanguages = locale_language_list();


    $widget .= sprintf('<%s data-wg-notranslate="" class="wgcurrent wg-li wg-flags %s"><a href="#" onclick="return false;">%s</a></%s>', $tag, $codeLanguages["destination"], $listLanguages[$codeLanguages["destination"]], $tag);

    $widget .= $listTag;
	foreach ($listLanguages as $keyCode => $lang) {
		if ($keyCode === $codeLanguages['destination']) {
			continue;
        }

        $widget .= sprintf('<li class="wg-li %s">', $flag_class . $keyCode);

        $basePath = "/$keyCode/$current_path";
        if($keyCode === $codeLanguages['original']){
            $basePath = "/$current_path";
        }

		$widget .= sprintf('<a data-wg-notranslate href="%s">%s</a>', $basePath , $listLanguages[$keyCode]);

		$widget .= '</li>';
	}
	$widget .= $listTag;

    $widget .= "</aside>";

    return $widget;
}
